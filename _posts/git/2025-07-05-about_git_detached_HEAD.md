---
layout: post
title:  "git detached HEADへの対処法"
date:   2025-07-05T14:25:52-05:00
author: rukaszz
categories: [git]
tags: [git]
permalink: /posts/git
---

# detached HEAD状態の解消

## detached HEAD状態とは

HEADとは現在作業している場所(ブランチあるいはコミット)を指す言葉であり，ポインタである．

**a1b2c3 HEAD@{0}: commit: Initial commit**

という状態の場合，HEAD@{0}→main→a1b2c3という順番であり，「HEAD@{0}時点でのmainブランチで，コミットIDがa1b2c3である」ということです．
メインブランチ(例：masterなど)から派生した，分離したmainブランチが作業用のブランチであり，それがコミットされていくという状態です．
ではdetached HEADとは何か．

```Bash
~$ git status
現在どのブランチ上でもありません。
nothing to commit, working tree clean
```

ふとGitで現在の状況を確認すると，上記の状態になってしまうことがあったりします．
これはdetachedという単語が表す通り，HEADが切り離された状態であり，HEADがブランチではなく特定のコミットに紐付いている状態です，例えば「git checkout <commit ID>」でコミットIDを指定してチェックアウトすると，HEADはそのコミットに向いている状態です．関係としては「HEAD→a1b2c3」であり，どのブランチにも属していないということです．

### 注意点

detached HEAD状態の何が問題かと言うと，このHEADは浮いた状態であり，あくまでも特定のコミットをそのまま抜き出した状態に近いです．例えば作業中にある別のブランチに切り替えたとします．するとこの浮いたHEADにはおそらく戻れなくなります．ガベージコレクションが働いて，detached状態のHEADが消えてしまいます．

detached状態でも，ファイルの編集やコミットを行うことは出来ますし，作業上特に不便なことはありません．しかし特定のブランチに所属していない都合上，ブランチの状態をリモートブランチへpushすることや，コミット内容がブランチへ記録されることもないです．つまりdetached HEADを持っている作業者以外から，当該HEADは見えていません．

逆にこれを活用して，過去のコミット状態を一時的に確認したい場合や，履歴を汚染せずに実験的な変更を試す場合などには有用であるとも言えます．

## 解消方法

意図せずdetached HEAD状態になってしまうと，バージョン管理がなされず，あるときコミット履歴を含めて消えてしまう可能性があります．そのため，解消する必要があります．解消方法としては，そのHEADをブランチ化してしまう方法があります：

```Bash
# -c オプションはブランチの新規作成
git switch -c new_branch_name
```

これによって，新しいブランチがメインブランチから切られた状態で，作業を進めることが出来ます．

### 本来のブランチへ合流する

意図せずdetached HEAD状態になった場合，元々作業していたブランチへ合流させたいこともあると思います．そのような場合は，仮のブランチを一時的に切って，それを元のブランチの最新コミットとして，元のブランチを更新する方法があります．ここでは復帰したいブランチ名をmainとして進めていきます．

まずはdetached HEADをブランチ化します：

```Bash
git switch -c main-temp
```

これによって，detached HEADはmain-tempブランチとして，メインブランチから切り離されました．次に合流させたいブランチ(今回はmain)へ切り替えます：

```Bash
# もしmainがローカル似ないなら，git fetch originで持ってくる
# git fetch origin
git switch main
```

後はmain-tempをmainへマージします：

```Bash
git merge main-temp
```

このとき，競合(コンフリクト)が発生する可能性があるので，念の為次の内容を確認しておくと安心です：

- ローカルのmainブランチの変更のコミット
- git pull origin mainでリモートと同期
- main-tempをmainでrebaseする
- 差分の事前確認

mergeが通れば，後はmainブランチで作業を再開できます．

### ※補足

Gitというツールの性質上，無理してmainブランチへ合流する必要は無いと思います．

```Bash
git switch -c main_ver3
```

など別名のブランチで新しく管理すれば良いと思います．結局メインブランチという主たるものが存在するため，ブランチが複数出来ても問題ないと思います．若干リモートレポジトリへのpush方法が変わるくらいかと：

```Bash
git push origin main_ver3
```




