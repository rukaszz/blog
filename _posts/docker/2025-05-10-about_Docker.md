---
layout: post
title:  "Dockerのはじめ方"
date:   2025-05-10T14:25:52-05:00
author: rukaszz
categories: [Docker]
permalink: /posts/Docker
---

# Dockerの基本設定

Ubuntu環境でDockerをインストールしてから起動，停止までをとりあえずまとめた．

## Dockerを起動

### インストール

いつものコマンドでインストールできます．

```Bash
sudo apt update
sudo apt install docker.io
```

### Dockerサービスの起動

インストールできたらDockerサービスを起動する．
なお，Dockerはシステムレベルのアクセスが必要であり，Dockerデーモンを使用してコンテナを管理する都合上，デーモンとのやり取りに管理者権限(sudo)が必要です．

```Bash
sudo systemctl start docker
sudo systemctl enable docker
```

### Dockerコンテナの起動

Docker Hubからコンテナを取得し，コンテナ起動する．
次のコマンドでは「nginx」イメージを使用しています．

※nginx：軽量なWebサーバとリバースプロキシとして使われるOSS．
※nginxイメージ：nginxが提供するDocker Hubのイメージ．簡単に言えばコンテナ内部で適切にリクエストを転送してくれるサーバを共に立ち上げる感じ？

```Bash
sudo docker run -d --name myContainer nginx
```

### コンテナに入る

起動したコンテナが正しく動作しているかを確認する：

```Bash
sudo docker ps
```

コンテナにアクセスするには，「exec」コマンドを使用する：

```Bash
sudo docker exec -it myContainer /bin/bash
```

「-it」はコンテナへの入出力が出力されるようになるコマンド？

「/bin/bash」はバッシュを起動するためのコマンドです．この記述が無くてもめちゃくちゃ軽量なイメージでもなければシェルは存在しているはずなので，

```Shell
bash
```

と記述すれば「/bin/bash」と同等の状態になるはず．

### Dockerの終了

Dockerの起動までを確認したので，上記の逆の手順で終了まで追っていきます．
まずコンテナからでるには「exit」コマンドを使います．「ctrl + D」でも出来るはず．

```Bash
exit
```

コンテナの動作を止めるには，

```Bash
sudo docker stop myContainer
```

コンテナを削除するには次のコマンドを使います．ただし，コンテナを止めていないと(基本的には)削除できません．

```Bash
sudo docker rm myContainer
```

ついでにDockerデーモンを停止させる場合は：

```Bash
sudo systemctl stop docker
```

別に停止させなくて良いのであれば：

```Bash
sudo systemctl disable docker
```

おそらくDockerデーモンを停止しても，再度やり取りをするため「docker.socket」は生きたままになります．

## Dockerの環境構築

起動したDockerがすっからかんなので，環境を構築しないといけません．
公式がだしているイメージを使うのが一番簡単です．

### 例：Python環境

```Bash
sudo docker run -it --name pythonContainer python:latest /bun/bash
```

これでコンテナ内で「pip」コマンドが使えるはずです．

### 複数の言語環境の構築

Dockerを使って複数の言語の環境をセットアップしたいことはままあるかと思います．
このような場合は一括でビルドするためにDockerfileを使います．

```Dockerfile
# ベースイメージ：ubuntu
FROM ubuntu:latest

# 必要なパッケージなどをインストール
RUN apt-get update && apt install -y build-essential \
    python3 python3-pip \
    rustc cargo

# 環境の確認
RUN gcc --version && python3 --version && rustc --version
```

aptは現状Dockerでは推奨されておらず，「apt-get」を使います．
また，「WARNING: apt does not have a stable CLI interface. Use with caution in scripts.」というワーニングが出現することがあります．
これは「apt」がCLIに向いてない的なワーニングなので，無視しても処理は進みます．
問題は次のエラーです．

「E: Unable to locate package XXX」というエラーが出現し，コンテナをbuildできません．
読めばわかる通り，パッケージの場所が見つからないとなっています．
私の場合は，「apt-get update」で「apt-get」そのものを更新すると解消しました．
「apt-get update」でapt-get自体をupdateしないとエラーとなることがあります．
また，それ以外の原因もあるそうです：[qiita.com/arila/items/1cd0245e29c38c7d7091](https://qiita.com/arila/items/1cd0245e29c38c7d7091)

この場合は「/etc/resolv.conf」を編集してGoogle Public DNSのIPアドレスなどを追加することになるでしょう．
上記のサイトを参考にした「resolv.conf」の編集内容の一例です：

```conf
# Generated by resolvconf
search flets-east.jp iptvf.jp
nameserver 2400:4053:121:e400:a10:86ff:fef3:87e0
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 1.1.1.1
nameserver 208.67.222.222  # OpenDNS address
```

### Dockerfileでビルド

Dockerfileを作成したら，イメージを作ります．

```Bash
sudo docker build -it myImage
```

これに時間がかかります．
終わったら上記の手順に従い，コンテナを作成し実行します．

```Bash
sudo docker run -d --name myContainer myImage
```

### 一括でコンテナを起動・管理する(docker-compose)

複数のコンテナを管理するために，都度Dockerfileなどを作成し，各々のディレクトリでゴニョゴニョするのは面倒です．
一括で管理するための設定ファイルがDockerには備わっています．
docker-compose.ymlはYAML形式のファイルで記述され，コマンドを1つずつ打つこと無くDockerイメージのビルド，各コンテナの起動などが行えるツールです．
なので基本的にはタブではなくスペース2つで段落を分けます．

これまではDockerfileを記述してそれを基にイメージの作成，コンテナの作成，起動などを行っっていましたが，おそらく一般的にはdocker-composeを利用してビルドから起動，停止までを実行します．

基本的な構文としては，次のようになると思います．各種設定値は各々の開発環境と相談して適宜決定する必要があります：

```YAML
# docker-composeのバージョンの指定(省略可能)：原則は3，1や2はサポートが終わっている古いもの
version: "3.3"  
services: # サービス(およびコンテナ)に関する記述
  app: # これはappというサービスに関するコンテナの設定
    image: python3.9 # 使用するイメージを記述
    container_name: myContainer # コンテナの名称(省略すると自動で振られる)
    ports: 
      - 8000:80 # コンテナのポートのマッピング
    volumes: 
      - /home/app:/app # ホストのディレクトリ(/home/app)を，コンテナの/appへマウントする
    environment: # 環境変数などを設定する(DBの接続情報とか)
      - MYSQL_ROOT_PW: password
      - MYDATABASE: yourDatabase
      - USERNAME: userName
      - MYSQL_PW: password
    depends_on: # 依存関係にあるコンテナの記述
      - db # appというサービスはdbというサービスが起動してから起動される
  db: # DB用のコンテナの設定
  # ...
volumes: 
  app: # 永続化するストレージの設定
```

このようにdocker-compose.ymlを作成したら，あとはコマンドを叩くだけです．

```Bash
sudo docker-compose up # イメージがなければビルドする
sudo docker-compose up -d # コンテナをバックグラウンドで起動(detatch)
sudo docker-compose up --build # イメージをビルドしてコンテナを作成・起動する
```

もろもろ確認：

```Bash
sudo docker ps # 起動しているコンテナ(-aで停止のものも含めてだせる)
sudo docker-conpose log serviceName # 特定のサービスのログ
```

起動：

```Bash
sudo docker-compose sudo docker run -d myContainer
```




